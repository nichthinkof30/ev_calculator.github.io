<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>EV Charger ROI Calculator</title>
    <meta name="description" content="EV Charger ROI Calculator Dashboard" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Bootstrap CSS -->
    <link
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f0f2f5;
      }
      .header {
        background-color: #fff;
        border-bottom: 1px solid #e5e5e5;
        padding: 15px 20px;
        text-align: center;
      }
      .content {
        padding: 20px;
      }
      .card {
        margin-bottom: 20px;
      }
      canvas {
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h3>EV Charger ROI Calculator</h3>
    </div>
    <div class="container content">
      <div id="root"></div>
    </div>

    <!-- React, ReactDOM, Babel, Chart.js, jQuery, Bootstrap JS -->
    <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" crossorigin="anonymous"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"
      crossorigin="anonymous"
    ></script>

    <script type="text/babel">
      function ROICalculator() {
        // Basic parameters
        const [costPerCharger, setCostPerCharger] = React.useState(5000);
        const [infrastructureCost, setInfrastructureCost] = React.useState(2000);
        const [chargerPowerRating, setChargerPowerRating] = React.useState(50);
        const [averageChargingPower, setAverageChargingPower] = React.useState(80);
        const [utilizationRate, setUtilizationRate] = React.useState(30);
        const [chargingFee, setChargingFee] = React.useState(1);
        const [electricityCost, setElectricityCost] = React.useState(0.5);
        const [profitSharing, setProfitSharing] = React.useState(20);
        const [projectionMonths, setProjectionMonths] = React.useState(12);

        // New parameters
        const [hostingFee, setHostingFee] = React.useState(80);
        const [maintenanceFee, setMaintenanceFee] = React.useState(350);
        const [taxImposed, setTaxImposed] = React.useState(0);
        const [governmentGrant, setGovernmentGrant] = React.useState(0);

        // Multi-section parameters (optional)
        const [sections, setSections] = React.useState([]);
        const [sectionsError, setSectionsError] = React.useState("");

        const [result, setResult] = React.useState(null);
        const hoursInMonth = 30 * 24; // 720 hours

        // Functions to manage sections
        const addSection = () => {
          setSections([...sections, { hours: 0, fee: 0, utilization: 0 }]);
        };

        const updateSection = (index, field, value) => {
          const newSections = [...sections];
          newSections[index][field] = parseFloat(value);
          setSections(newSections);
        };

        const removeSection = (index) => {
          const newSections = [...sections];
          newSections.splice(index, 1);
          setSections(newSections);
        };

        // Validate that the sum of hours across sections is â‰¤ 24
        React.useEffect(() => {
          const totalHours = sections.reduce((sum, sec) => sum + (sec.hours || 0), 0);
          if (totalHours > 24) {
            setSectionsError("Total hours in all sections must not exceed 24.");
          } else {
            setSectionsError("");
          }
        }, [sections]);

        // Calculation function
        const calculateROI = () => {
          let monthlyRevenue, monthlyElectricityCost;
          if (sections.length > 0) {
            // Use multi-section calculation
            let dailyRevenue = 0;
            let dailyElectricity = 0;
            sections.forEach(sec => {
              dailyRevenue += chargerPowerRating * (sec.utilization / 100) * sec.fee * sec.hours;
              dailyElectricity += chargerPowerRating * (sec.utilization / 100) * electricityCost * sec.hours;
            });
            monthlyRevenue = dailyRevenue * 30;
            monthlyElectricityCost = dailyElectricity * 30;
          } else {
            // Use default calculation
            const energyDelivered = chargerPowerRating * (averageChargingPower / 100) * ((utilizationRate / 100) * hoursInMonth);
            monthlyRevenue = energyDelivered * chargingFee;
            monthlyElectricityCost = energyDelivered * electricityCost;
          }

          const monthlyExpenses = monthlyElectricityCost + hostingFee + maintenanceFee;
          const grossProfit = monthlyRevenue - monthlyExpenses;
          const partnerPayment = grossProfit * (profitSharing / 100);
          const netProfitBeforeTax = grossProfit - partnerPayment;
          const monthlyNetProfit = netProfitBeforeTax * (1 - taxImposed / 100);

          // Total investment reduced by government grant (not below 0)
          let totalInvestment = costPerCharger + infrastructureCost - governmentGrant;
          if (totalInvestment < 0) totalInvestment = 0;

          const monthlyROI = totalInvestment > 0 ? (monthlyNetProfit / totalInvestment) * 100 : 0;
          const annualROI = monthlyROI * 12;

          return {
            monthlyRevenue,
            monthlyElectricityCost,
            monthlyExpenses,
            grossProfit,
            partnerPayment,
            monthlyNetProfit,
            monthlyROI,
            annualROI,
            totalInvestment,
          };
        };

        const handleSubmit = (e) => {
          e.preventDefault();
          if (sectionsError) return;
          const res = calculateROI();
          setResult(res);
        };

        // Compute Break Even Month:
        // Month 1 net income = -(totalInvestment + monthlyExpenses), subsequent months = monthlyNetProfit
        const getBreakEvenMonth = () => {
          if (!result) return null;
          let cumulative = 0;
          for (let i = 1; i <= projectionMonths; i++) {
            const monthlyIncome = i === 1 ? -(result.totalInvestment + result.monthlyExpenses) : result.monthlyNetProfit;
            cumulative += monthlyIncome;
            if (cumulative >= 0) return i;
          }
          return "Not reached within projection period";
        };

        // Chart.js integration:
        // - Cumulative Net Income: Month 1 = -(totalInvestment + monthlyExpenses), Months 2+ = monthlyNetProfit (cumulative)
        // - Total Expenses: Month 1 = (totalInvestment + monthlyExpenses), Months 2+ = monthlyExpenses (non-cumulative)
        const chartRef = React.useRef(null);
        const chartInstanceRef = React.useRef(null);

        React.useEffect(() => {
          if (result) {
            let cumulativeNetIncome = [];
            let runningTotal = 0;
            for (let i = 1; i <= projectionMonths; i++) {
              const monthlyIncome = i === 1 ? -(result.totalInvestment + result.monthlyExpenses) : result.monthlyNetProfit;
              runningTotal += monthlyIncome;
              cumulativeNetIncome.push(runningTotal);
            }
            let expenseValues = [];
            for (let i = 1; i <= projectionMonths; i++) {
              expenseValues.push(i === 1 ? (result.totalInvestment + result.monthlyExpenses) : result.monthlyExpenses);
            }
            const labels = [];
            for (let i = 1; i <= projectionMonths; i++) {
              labels.push("M" + i);
            }

            if (chartInstanceRef.current) {
              chartInstanceRef.current.data.labels = labels;
              chartInstanceRef.current.data.datasets[0].data = cumulativeNetIncome;
              chartInstanceRef.current.data.datasets[1].data = expenseValues;
              chartInstanceRef.current.update();
            } else {
              const ctx = chartRef.current.getContext('2d');
              chartInstanceRef.current = new Chart(ctx, {
                type: 'line',
                data: {
                  labels: labels,
                  datasets: [
                    {
                      label: 'Cumulative Net Income (RM)',
                      data: cumulativeNetIncome,
                      segment: {
                        borderColor: ctx => ctx.p0.parsed.y < 0 ? 'red' : 'green'
                      },
                      backgroundColor: 'rgba(75, 192, 192, 0.2)',
                      fill: true,
                      tension: 0.1,
                    },
                    {
                      label: 'Total Expenses (RM)',
                      data: expenseValues,
                      borderColor: 'rgba(255, 99, 132, 1)',
                      backgroundColor: 'rgba(255, 99, 132, 0.2)',
                      fill: false,
                      tension: 0.1,
                    },
                  ],
                },
                options: {
                  responsive: true,
                  scales: {
                    y: {
                      beginAtZero: true,
                    },
                  },
                },
              });
            }
          }
        }, [result, projectionMonths]);

        // Helper for human-readable formatting
        const formatNumber = (num) => {
          return Number(num).toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          });
        };

        // Build table rows for projection months
        // Table order:
        // Month | Setup Cost | Total Revenue | Monthly Operation Expenses | Partner Profit Sharing | Monthly Net Income | Total Net Income
        const renderTableRows = () => {
          if (!result) return null;
          const rows = [];
          let cumulativeNetIncome = 0;
          for (let i = 1; i <= projectionMonths; i++) {
            const cumulativeRevenue = (i - 1) * result.monthlyRevenue;
            const monthlyExpense = result.monthlyExpenses;
            const monthlyNetIncome = i === 1 ? -(result.totalInvestment + result.monthlyExpenses) : result.monthlyNetProfit;
            const partnerProfit = i === 1 ? 0 : result.partnerPayment;
            cumulativeNetIncome += monthlyNetIncome;
            rows.push(
              <tr key={i}>
                <td>{i}</td>
                <td>{i === 1 ? formatNumber(result.totalInvestment) : '-'}</td>
                <td>{formatNumber(cumulativeRevenue)}</td>
                <td>{formatNumber(monthlyExpense)}</td>
                <td>{formatNumber(partnerProfit)}</td>
                <td>{formatNumber(monthlyNetIncome)}</td>
                <td>{formatNumber(cumulativeNetIncome)}</td>
              </tr>
            );
          }
          return rows;
        };

        return (
          <div className="card">
            <div className="card-body">
              <form onSubmit={handleSubmit}>
                {/* Basic Inputs */}
                <div className="form-group">
                  <label>Cost per Charger (RM):</label>
                  <input type="number" className="form-control" value={costPerCharger} onChange={e => setCostPerCharger(parseFloat(e.target.value))} />
                </div>
                <div className="form-group">
                  <label>Infrastructure Cost (RM):</label>
                  <input type="number" className="form-control" value={infrastructureCost} onChange={e => setInfrastructureCost(parseFloat(e.target.value))} />
                </div>
                <div className="form-group">
                  <label>Charger Power Rating (kW):</label>
                  <input type="number" className="form-control" value={chargerPowerRating} onChange={e => setChargerPowerRating(parseFloat(e.target.value))} />
                </div>
                {/* If no custom sections, show default parameters */}
                {sections.length === 0 && (
                  <>
                    <div className="form-group">
                      <label>Average Charging Power (%):</label>
                      <input type="number" className="form-control" value={averageChargingPower} onChange={e => setAverageChargingPower(parseFloat(e.target.value))} />
                    </div>
                    <div className="form-group">
                      <label>Utilization Rate (%):</label>
                      <input type="number" className="form-control" value={utilizationRate} onChange={e => setUtilizationRate(parseFloat(e.target.value))} />
                    </div>
                    <div className="form-group">
                      <label>Charging Fee (RM/kWh):</label>
                      <input type="number" className="form-control" value={chargingFee} onChange={e => setChargingFee(parseFloat(e.target.value))} />
                    </div>
                  </>
                )}
                {/* Custom Charging Sections */}
                <div className="mb-3">
                  <h5>Custom Charging Sections (Optional)</h5>
                  <p className="text-muted">Define sections for different time blocks (Total hours â‰¤ 24)</p>
                  {sections.map((sec, index) => (
                    <div key={index} className="form-row align-items-end mb-2">
                      <div className="col">
                        <label>Hours</label>
                        <input type="number" className="form-control" value={sec.hours} onChange={e => updateSection(index, 'hours', e.target.value)} />
                      </div>
                      <div className="col">
                        <label>Charging Fee (RM/kWh)</label>
                        <input type="number" className="form-control" value={sec.fee} onChange={e => updateSection(index, 'fee', e.target.value)} />
                      </div>
                      <div className="col">
                        <label>Utilization Rate (%)</label>
                        <input type="number" className="form-control" value={sec.utilization} onChange={e => updateSection(index, 'utilization', e.target.value)} />
                      </div>
                      <div className="col-auto">
                        <button type="button" className="btn btn-danger" onClick={() => removeSection(index)}>X</button>
                      </div>
                    </div>
                  ))}
                  {sectionsError && <p className="text-danger">{sectionsError}</p>}
                  <button type="button" className="btn btn-secondary btn-sm" onClick={addSection}>Add Section</button>
                </div>
                {/* Additional Inputs */}
                <div className="form-group">
                  <label>Electricity Cost (RM/kWh):</label>
                  <input type="number" className="form-control" value={electricityCost} onChange={e => setElectricityCost(parseFloat(e.target.value))} />
                </div>
                <div className="form-group">
                  <label>Profit Sharing (% of Gross Profit):</label>
                  <input type="number" className="form-control" value={profitSharing} onChange={e => setProfitSharing(parseFloat(e.target.value))} />
                </div>
                <div className="form-group">
                  <label>Hosting Fee (RM):</label>
                  <input type="number" className="form-control" value={hostingFee} onChange={e => setHostingFee(parseFloat(e.target.value))} />
                </div>
                <div className="form-group">
                  <label>Maintenance Fee (RM):</label>
                  <input type="number" className="form-control" value={maintenanceFee} onChange={e => setMaintenanceFee(parseFloat(e.target.value))} />
                </div>
                <div className="form-group">
                  <label>Tax Imposed (%):</label>
                  <input type="number" className="form-control" value={taxImposed} onChange={e => setTaxImposed(parseFloat(e.target.value))} />
                </div>
                <div className="form-group">
                  <label>Government Grant (RM):</label>
                  <input type="number" className="form-control" value={governmentGrant} onChange={e => setGovernmentGrant(parseFloat(e.target.value))} />
                </div>
                <div className="form-group">
                  <label>Projection Months:</label>
                  <input type="number" className="form-control" value={projectionMonths} onChange={e => setProjectionMonths(parseInt(e.target.value))} />
                </div>
                <button type="submit" className="btn btn-primary" disabled={sectionsError !== ""}>
                  Calculate ROI
                </button>
              </form>
              {result && (
                <div className="mt-4">
                  <h4>Results</h4>
                  <p>
                    <strong>Monthly Energy Delivered:</strong>{" "}
                    {sections.length === 0
                      ? formatNumber(chargerPowerRating * (averageChargingPower/100) * ((utilizationRate/100)*hoursInMonth))
                      : "Calculated via sections"}
                  </p>
                  <p>
                    <strong>Total Charging Revenue (per month):</strong> RM{" "}
                    {formatNumber(result.monthlyRevenue)}
                  </p>
                  <p>
                    <strong>Monthly Electricity Cost:</strong> RM{" "}
                    {formatNumber(result.monthlyElectricityCost)}
                  </p>
                  <p>
                    <strong>Monthly Operation Expense (Electricity, Hosting & Maintenance):</strong> RM{" "}
                    {formatNumber(result.monthlyExpenses)}
                  </p>
                  <p>
                    <strong>Gross Profit (Before Profit Sharing):</strong> RM{" "}
                    {formatNumber(result.grossProfit)}
                  </p>
                  <p>
                    <strong>Partner Payment (Profit Sharing):</strong> RM{" "}
                    {formatNumber(result.partnerPayment)}
                  </p>
                  <p>
                    <strong>Monthly Net Profit (After Tax):</strong> RM{" "}
                    {formatNumber(result.monthlyNetProfit)}
                  </p>
                  <p>
                    <strong>Monthly ROI:</strong> {formatNumber(result.monthlyROI)}%
                  </p>
                  <p>
                    <strong>Annual ROI:</strong> {formatNumber(result.annualROI)}%
                  </p>
                  <p>
                    <strong>Total Investment (Setup & Purchase Cost minus Grant):</strong> RM{" "}
                    {formatNumber(result.totalInvestment)}
                  </p>
                  <p>
                    <strong>Break Even Month:</strong> {getBreakEvenMonth()}
                  </p>
                  <canvas ref={chartRef} width="600" height="400"></canvas>

                  <h4 className="mt-4">Projection (over {projectionMonths} months)</h4>
                  <table className="table table-bordered table-striped">
                    <thead>
                      <tr>
                        <th>Month</th>
                        <th>Setup Cost (RM)</th>
                        <th>Total Revenue (RM)</th>
                        <th>Monthly Operation Expenses (RM)</th>
                        <th>Partner Profit Sharing (RM)</th>
                        <th>Monthly Net Income (RM)</th>
                        <th>Total Net Income (RM)</th>
                      </tr>
                    </thead>
                    <tbody>{renderTableRows()}</tbody>
                  </table>
                </div>
              )}
            </div>
          </div>
        );
      }

      ReactDOM.render(<ROICalculator />, document.getElementById('root'));
    </script>
  </body>
</html>
